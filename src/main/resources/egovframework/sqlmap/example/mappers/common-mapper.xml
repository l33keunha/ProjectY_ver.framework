<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ybs.indicator.common.service.impl.CommonMapper">
		
	<!-- Ajax: 분석지역 시도 조회 -->
	<select id ="selectPassSearchAjaxAnalAreaCd" parameterType="sVO" resultType="egovMap">
		SELECT DISTINCT 분석지역_CD_시도 ANAL_AREA_CD_SIDO
          ,CASE WHEN 분석지역_CD_시도 = '31' THEN  '경기도'
                WHEN 분석지역_CD_시도 = '32' THEN  '강원도'
                WHEN 분석지역_CD_시도 = '34' THEN  '충청남도'
               ELSE 분석지역명
               END  ANAL_AREA_NM
		FROM 분석지역_CD A, USER_INFO B, USER_DEPT C
		WHERE 1=1
			AND B.DEPT = C.DEPT 
			AND C.ANAL_AREA_CD = A.분석지역_CD 
			AND B.UNO = #{uNo}
		ORDER BY 분석지역_CD_시도
	</select>
	
	<!-- Ajax: 분석지역 시군구 조회 -->
	<select id ="selectPassSearchAjaxAnalArea" parameterType="sVO" resultType="egovMap">
		SELECT DISTINCT 분석지역_CD ANAL_AREA_CD
		  ,CASE WHEN 분석지역_CD LIKE '__' THEN '전체' ELSE 분석지역명 END analAreaNm
		FROM 분석지역_CD A, USER_INFO B, USER_DEPT C
		WHERE 1=1
			AND B.DEPT = C.DEPT 
			AND C.ANAL_AREA_CD = A.분석지역_CD 
			AND B.UNO = #{uNo}
			AND 분석지역_CD_시도 = #{anal_area_cd_sido}
		ORDER BY 분석지역_CD
	</select>

	<!-- Ajax: 분석자료 조회 -->
	<select id ="selectPassSearchAjaxProvider" parameterType="sVO" resultType="egovMap">
		SELECT DISTINCT OWNER PROVIDER
		FROM 분석지역_CD
		WHERE 1=1
			AND 분석지역_CD = #{anal_area_cd}
		ORDER BY OWNER
	</select>
	
	<!-- Ajax: 날짜 조회 -->
	<select id ="selectPassSearchAjaxDate" parameterType="sVO" resultType="egovMap">
		SELECT DISTINCT 운행일자 OPRAT_DATE, 유효일자 SDATE
		FROM 분석지역_CD
		WHERE 1=1
			AND 분석지역_CD = #{anal_area_cd}
			AND OWNER = #{provider}
		ORDER BY 운행일자
	</select>
	
	<!-- Ajax: 분석 노선번호 조회 -->
	<select id ="selectPassRouteIdList" parameterType="sVO" resultType="egovMap">
		SELECT /*+ PARALLEL(8) */ DISTINCT 정산사ID TCBO_ID, 노선ID ROUTE_ID, 노선명칭 ROUTE_NMA, NVL(유형, '-') ROUTE_TYPE
	 		,기점 ROUTE_START
	        ,종점 ROUTE_END
		FROM STDNN_BRS
		WHERE 1=1
		<![CDATA[
			AND 운행일자 <=#{dateStart}
			AND 유효일자 >=#{dateStart}
		]]>
			<if test="tmStart==2"> 
				AND 인허가지역코드_시도 =#{anal_area_cd}
			</if>
			<if test="tmStart==5">
				AND 인허가지역코드 =#{anal_area_cd}
			</if> 
			AND OWNER =#{provider}
		ORDER BY ROUTE_NMA
	</select>
	
	<!-- Ajax: 이용자유형 리스트 조회 -->
	<select id="selectCdNoList" parameterType="sVO" resultType="egovMap">
		SELECT DISTINCT 코드번호 cdNo, 이용자유형분류 cdNoNm
		FROM CMM_USERTYPE 
		WHERE 1=1
			AND OWNER =#{provider}
			AND 코드번호 IS NOT NULL
		ORDER BY 코드번호
	</select>
	
	
	
	
	
	
	
	<!-- Ajax: 분석지역 시도 조회 _다운로드 -->
	<select id ="selectPassSearchAjaxAnalAreaCd_dl" parameterType="sVO" resultType="egovMap">
		SELECT DISTINCT SUBSTR(A.분석지역_CD,0,2) ANAL_AREA_CD_SIDO
          ,CASE WHEN SUBSTR(A.분석지역_CD,0,2) = '11' THEN  '서울특별시'
          		WHEN SUBSTR(A.분석지역_CD,0,2) = '23' THEN  '인천광역시'
          		WHEN SUBSTR(A.분석지역_CD,0,2) = '31' THEN  '경기도'
                WHEN SUBSTR(A.분석지역_CD,0,2) = '32' THEN  '강원도'
                WHEN SUBSTR(A.분석지역_CD,0,2) = '34' THEN  '충청남도'
                ELSE A.분석지역_CD
                END  ANAL_AREA_NM
		FROM 지표별ROW_COUNT A, USER_INFO B, USER_DEPT C
		WHERE 1=1
			AND B.DEPT = C.DEPT 
			AND C.ANAL_AREA_CD = A.분석지역_CD 
			AND B.UNO = #{uNo}
		ORDER BY ANAL_AREA_CD_SIDO
	</select>
	
	<!-- Ajax: 분석지역 시군구 조회 _다운로드 -->
	<select id ="selectPassSearchAjaxAnalArea_dl" parameterType="sVO" resultType="egovMap">
		SELECT DISTINCT 
				A.분석지역_CD ANAL_AREA_CD
				,CASE WHEN A.분석지역_CD LIKE '__' THEN '전체' ELSE 분석지역명 END analAreaNm 
		FROM 지표별ROW_COUNT A, USER_INFO B, USER_DEPT C, 분석지역_CD D
		WHERE 1=1
			AND B.DEPT = C.DEPT 
			AND C.ANAL_AREA_CD = A.분석지역_CD 
			AND B.UNO = #{uNo}
			AND A.분석지역_CD = D.분석지역_CD 
			AND A.분석지역_CD LIKE #{anal_area_cd_sido} || '%'
		ORDER BY A.분석지역_CD
	</select>

	<!-- Ajax: 분석자료 조회 _다운로드 -->
	<select id ="selectPassSearchAjaxProvider_dl" parameterType="sVO" resultType="egovMap">
		SELECT DISTINCT OWNER PROVIDER
		FROM 지표별ROW_COUNT
		WHERE 1=1
			AND 분석지역_CD = #{anal_area_cd}
		ORDER BY OWNER
	</select>
	
	<!-- Ajax: 날짜 조회 _다운로드 -->
	<select id ="selectPassSearchAjaxDate_dl" parameterType="sVO" resultType="egovMap">
		SELECT DISTINCT 
	        TO_CHAR(MIN(운행일자) OVER (PARTITION BY SUBSTR(운행일자, 0,6) ORDER BY 운행일자),'YYYYMMDD') OPRAT_DATE
	        ,TO_CHAR(MAX(유효일자) OVER (PARTITION BY SUBSTR(운행일자, 0,6) ORDER BY 운행일자),'YYYYMMDD') SDATE
		FROM
		    (
		        SELECT  
		            FIRST_VALUE(SDATE) OVER (PARTITION BY SUBSTR(SDATE, 0,6) ORDER BY SDATE) 운행일자
		            ,LAST_VALUE(SDATE) OVER (PARTITION BY SUBSTR(SDATE, 0,6) ORDER BY SDATE) 유효일자
		        FROM 지표별ROW_COUNT  
		        WHERE 1=1
			AND 분석지역_CD = #{anal_area_cd}
			AND OWNER = #{provider}
		    )
		ORDER BY OPRAT_DATE
	</select>
	
	
	<!-- Ajax: 지역에 따른 가능 여부 status조회 -->
	<select id="selectSearchStatusList" parameterType="sVO" resultType="egovMap">
		SELECT STATUS
		FROM 지표별ROW_COUNT
		WHERE 1=1 
			AND SDATE = TO_DATE(#{dateStart}, 'YYYY-MM-DD')
			AND 분석지표구분 = #{anal_fin}
			AND 분석지역_CD = #{anal_area_cd}
	</select>
	
	
	<!-- Ajax: 다운로드 가능여부 리스트 -->
	<select id="selectDownloadList" parameterType="sVO" resultType="egovMap">
		SELECT DISTINCT 
	        TO_CHAR(MIN(운행일자) OVER (PARTITION BY SUBSTR(운행일자, 0,6) ORDER BY 운행일자),'YYYYMMDD') OPRAT_DATE
	        ,TO_CHAR(MAX(유효일자) OVER (PARTITION BY SUBSTR(운행일자, 0,6) ORDER BY 운행일자),'YYYYMMDD') SDATE
            ,분석지역_CD
            ,분석지역명
			,ROW_COUNT
			,분석지표구분
			,OWNER
			,STATUS
		FROM
		    (
		        SELECT  
		            FIRST_VALUE(A.SDATE) OVER (PARTITION BY SUBSTR(A.SDATE, 0,6) ORDER BY SDATE) 운행일자
		            ,LAST_VALUE(A.SDATE) OVER (PARTITION BY SUBSTR(A.SDATE, 0,6) ORDER BY SDATE) 유효일자
		            ,A.분석지역_CD
					,A.ROW_COUNT
					,분석지표구분
					,A.OWNER
					,A.STATUS
					,D.분석지역명 
		        FROM 지표별ROW_COUNT A, USER_INFO B, USER_DEPT C, 분석지역_CD D
		        WHERE 1=1
					AND B.DEPT = C.DEPT 
					AND C.ANAL_AREA_CD = A.분석지역_CD 
					AND B.UNO = '1'
					AND A.분석지역_CD = D.분석지역_CD 
		    )
		ORDER BY 분석지표구분, OPRAT_DATE, 분석지역_CD
		
	</select>
	
	
	
</mapper>